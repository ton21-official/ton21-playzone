<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>T21 Play Zone</title>
<link rel="icon" href="https://raw.githubusercontent.com/ton21-official/ton21_official/main/logo.png"/>

<!-- Telegram Mini App API (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ –≤ Telegram) -->
<script>
  window.Telegram = window.Telegram || {};
  Telegram.WebApp = Telegram.WebApp || { expand(){}, ready(){}, initDataUnsafe:{} };
</script>

<style>
  :root{
    --bg:#0b0f16; --panel:#111724;
    --gold1:#ffdf88; --gold2:#f0cf6d;
    --txt:#e8ecf7; --muted:#9fb0c3; --line:#1e2637;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; color:var(--txt); background:var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
  }
  .wrap{ max-width:520px; margin:0 auto; padding:16px 16px 48px }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:10px }
  h1{ font-size:22px; margin:8px 0 14px 0; }
  .pill{ padding:6px 10px; background:#1c2437; border:1px solid var(--line); border-radius:12px; color:var(--txt); cursor:pointer; }
  .card{
    background:var(--panel); border:1px solid var(--line);
    border-radius:16px; padding:16px; margin:14px 0; box-shadow:0 8px 24px rgba(0,0,0,.25);
  }
  .sub{ color:var(--muted); font-size:14px; margin:6px 0 10px }
  .title-big{ font-size:40px; font-weight:800; letter-spacing:.5px }
  .btn{
    width:100%; padding:14px 16px; border:none; cursor:pointer; border-radius:14px;
    background:linear-gradient(180deg, var(--gold1), var(--gold2)); color:#121212; font-weight:700;
    font-size:16px; margin-top:10px;
  }
  .btn.secondary{
    background:transparent; color:var(--gold1);
    border:2px solid var(--gold2); font-weight:600;
  }
  .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:12px }
  .key{
    background:#0f1522; border:1px solid var(--line); border-radius:12px; padding:18px;
    text-align:center; font-size:22px; cursor:pointer; user-select:none;
  }
  input{
    width:100%; padding:14px; background:#0d131f; border:1px solid #202a3e; color:var(--txt);
    border-radius:12px; font-size:15px; margin-top:12px;
  }
  .small{ font-size:12px; color:var(--muted) }
  /* Ad modal */
  .modal-back{
    position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50;
  }
  .modal{
    width:min(480px, 92vw); background:#0f1522; border:1px solid var(--line); border-radius:16px; padding:18px;
  }
  .bar{
    height:10px; width:100%; background:#0b0f16; border:1px solid var(--line); border-radius:8px; overflow:hidden; margin:10px 0 14px;
  }
  .fill{ height:100%; width:0%; background:linear-gradient(180deg, var(--gold1), var(--gold2)); transition:width .2s linear }
  .row-btns{ display:flex; gap:10px }
  .muted{ color:var(--muted) }
</style>
</head>
<body>
<div class="wrap">

  <div class="row">
    <h1>T21 Play Zone</h1>
    <button id="langBtn" class="pill">üåê EN</button>
  </div>

  <div class="card">
    <div class="sub" id="titleTxt">Your T21 balance:</div>
    <div class="title-big"><span id="balance">0</span></div>

    <div class="sub">
      <span id="playsTxt">Plays</span>: <b id="plays">0</b>
      &nbsp;‚Äî&nbsp;
      <span id="limitTxt">Limit</span>: <b id="limit">0</b>
    </div>

    <button class="btn" id="btnAd100">Watch Premium Ad (+100)</button>
    <button class="btn secondary" id="btnAd10">Watch Premium Ad (+10)</button>
    <div class="small" id="adNote">Ad is a 30s simulation with Skip after 5s.</div>
  </div>

  <div class="card">
    <div id="guessTxt" class="sub">Guess 1‚Äì9 to win T21 (reward up to 50).</div>
    <div class="grid" id="grid"></div>

    <input id="addr" placeholder="Your TON address (EQ/UQ‚Ä¶)" />
    <div class="small" id="addrHint">We‚Äôll save the address for payouts.</div>

    <button class="btn" id="btnPayout">Request payout</button>
    <button class="btn secondary" id="btnShare">üîó Share</button>
  </div>

</div>

<!-- Ad modal -->
<div class="modal-back" id="adBack">
  <div class="modal">
    <div class="row" style="margin-bottom:4px">
      <div id="adTitle" style="font-weight:700">Sponsored Video</div>
      <div id="adTimer" class="muted">30s</div>
    </div>
    <div class="bar"><div class="fill" id="adFill"></div></div>
    <div class="small muted" id="adText">Please wait‚Ä¶ You can skip after 5 seconds.</div>
    <div class="row-btns" style="margin-top:10px">
      <button class="btn secondary" id="btnSkip" disabled>Skip</button>
      <button class="btn" id="btnClose" style="display:none">Close & Claim</button>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const API = "https://t21-playzone-api.t21playzone.workers.dev";
const SHARE_URL = "https://ton21project.com/playzone"; // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ—Ç–∞
Telegram?.WebApp?.expand?.();
Telegram?.WebApp?.ready?.();

/* ===================== I18N ===================== */
const I18N = {
  en:{
    balance:"Your T21 balance:",
    plays:"Plays", limit:"Limit",
    ad100:"Watch Premium Ad (+100)",
    ad10:"Watch Premium Ad (+10)",
    adNote:"Ad is a 30s simulation with Skip after 5s.",
    guess:"Guess 1‚Äì9 to win T21 (reward up to 50).",
    addrPh:"Your TON address (EQ/UQ‚Ä¶)",
    addrHint:"We‚Äôll save the address for payouts.",
    payout:"Request payout", share:"Share",
    invalid_addr:"Enter a valid TON address",
    limit_reached:"Game limit reached. Come back later! ‚è≥",
    win:"üéâ You won", lose_prefix:"üò¢ You chose", lose_mid:"but it was",
    lose_tail:"‚Ä¶ Try again!"
  },
  ru:{
    balance:"–í–∞—à –±–∞–ª–∞–Ω—Å T21:",
    plays:"–ò–≥—Ä—ã", limit:"–õ–∏–º–∏—Ç",
    ad100:"–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É (+100)",
    ad10:"–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É (+10)",
    adNote:"–ò–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ 30 —Å–µ–∫, Skip —á–µ—Ä–µ–∑ 5 —Å–µ–∫.",
    guess:"–£–≥–∞–¥–∞–π 1‚Äì9 –∏ –≤—ã–∏–≥—Ä–∞–π T21 (–ø—Ä–∏–∑ –¥–æ 50).",
    addrPh:"–í–∞—à TON-–∞–¥—Ä–µ—Å (EQ/UQ‚Ä¶)",
    addrHint:"–°–æ—Ö—Ä–∞–Ω–∏–º –∞–¥—Ä–µ—Å –¥–ª—è –≤—ã–ø–ª–∞—Ç.",
    payout:"–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É", share:"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è",
    invalid_addr:"–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π TON-–∞–¥—Ä–µ—Å",
    limit_reached:"–õ–∏–º–∏—Ç –∏–≥—Ä –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ–∑–∂–µ! ‚è≥",
    win:"üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏", lose_prefix:"üò¢ –í—ã –≤—ã–±—Ä–∞–ª–∏", lose_mid:"–∞ –≤—ã–ø–∞–ª–æ",
    lose_tail:"‚Ä¶ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë!"
  },
  zh:{
    balance:"‰Ω†ÁöÑ T21 ‰ΩôÈ¢ùÔºö",
    plays:"Ê¨°Êï∞", limit:"‰∏äÈôê",
    ad100:"ËßÇÁúãÂπøÂëäÔºà+100Ôºâ",
    ad10:"ËßÇÁúãÂπøÂëäÔºà+10Ôºâ",
    adNote:"30 ÁßíÂπøÂëäÊ®°ÊãüÔºå5 ÁßíÂêéÂèØË∑≥Ëøá„ÄÇ",
    guess:"Áåú 1‚Äì9 Ëµ¢ T21ÔºàÊúÄÈ´òÂ•ñÂä± 50Ôºâ„ÄÇ",
    addrPh:"‰Ω†ÁöÑ TON Âú∞ÂùÄÔºàEQ/UQ‚Ä¶Ôºâ",
    addrHint:"Êàë‰ª¨‰ºö‰øùÂ≠òÂú∞ÂùÄÁî®‰∫éÂèëÊîæÂ•ñÂä±„ÄÇ",
    payout:"Áî≥ËØ∑ÊèêÁé∞", share:"ÂàÜ‰∫´",
    invalid_addr:"ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ TON Âú∞ÂùÄ",
    limit_reached:"Â∑≤ËææÊ∏∏Êàè‰∏äÈôêÔºåËØ∑Á®çÂêéÂÜçÊù•ÔºÅ‚è≥",
    win:"üéâ ‰Ω†Ëµ¢Âæó‰∫Ü", lose_prefix:"üò¢ ‰Ω†ÈÄâÊã©‰∫Ü", lose_mid:"‰ΩÜÂÆûÈôÖÊòØ",
    lose_tail:"‚Ä¶ ÂÜçËØï‰∏ÄÊ¨°ÂêßÔºÅ"
  },
  hi:{
    balance:"‡§Ü‡§™‡§ï‡§æ T21 ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏:",
    plays:"‡§ñ‡•á‡§≤", limit:"‡§∏‡•Ä‡§Æ‡§æ",
    ad100:"‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§¶‡•á‡§ñ‡•á‡§Ç (+100)",
    ad10:"‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§¶‡•á‡§ñ‡•á‡§Ç (+10)",
    adNote:"30 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§ü‡•á‡§° ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®, 5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§¨‡§æ‡§¶ Skip‡•§",
    guess:"1‚Äì9 ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® ‡§≤‡§ó‡§æ‡§è‡§Å (‡§á‡§®‡§æ‡§Æ ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 50)‡•§",
    addrPh:"‡§Ü‡§™‡§ï‡§æ TON ‡§™‡§§‡§æ (EQ/UQ‚Ä¶)",
    addrHint:"‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§§‡§æ ‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ‡•§",
    payout:"‡§™‡•á‡§µ‡§æ‡§â‡§ü ‡§Æ‡§æ‡§Å‡§ó‡•á‡§Ç", share:"‡§∂‡•á‡§Ø‡§∞",
    invalid_addr:"‡§µ‡•à‡§ß TON ‡§™‡§§‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
    limit_reached:"‡§ñ‡•á‡§≤ ‡§∏‡•Ä‡§Æ‡§æ ‡§™‡•Ç‡§∞‡•Ä‡•§ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§Ü‡§è‡§Å! ‚è≥",
    win:"üéâ ‡§Ü‡§™‡§®‡•á ‡§ú‡•Ä‡§§‡•á", lose_prefix:"üò¢ ‡§Ü‡§™‡§®‡•á ‡§ö‡•Å‡§®‡§æ", lose_mid:"‡§™‡§∞ ‡§®‡§ø‡§ï‡§≤‡§æ",
    lose_tail:"‚Ä¶ ‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç!"
  },
  hy:{
    balance:"’î’∏ T21 ’∞’°’∑’æ’•’Ø’∑’´’º’®:",
    plays:"‘Ω’°’≤’•÷Ä", limit:"’ç’°’∞’¥’°’∂",
    ad100:"‘¥’´’ø’•’¨ ’£’∏’æ’°’¶’§’® (+100)",
    ad10:"‘¥’´’ø’•’¨ ’£’∏’æ’°’¶’§’® (+10)",
    adNote:"30 ’æ÷Ä’Ø. ’´’¥’´’ø’°÷Å’æ’°’Æ ’£’∏’æ’°’¶’§, Skip’ù 5 ’æ÷Ä’Ø-’´÷Å ’∞’•’ø’∏÷â",
    guess:"‘ø’º’°’∞’´÷Ä 1‚Äì9 (’¥÷Ä÷Å’°’∂’°’Ø’ù ’¥’´’∂’π÷á 50):",
    addrPh:"’î’∏ TON ’∞’°’Ω÷Å’•’∂ (EQ/UQ‚Ä¶)",
    addrHint:"’é’≥’°÷Ä’∏÷Ç’¥’∂’•÷Ä’´ ’∞’°’¥’°÷Ä ’Ø’∫’°’∞’∫’°’∂’æ’´ ’∞’°’Ω÷Å’•’∂÷â",
    payout:"‘¥’´’¥’•’¨ ’æ’≥’°÷Ä’¥’°’∂", share:"‘ø’´’Ω’æ’•’¨",
    invalid_addr:"’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’≥’´’∑’ø TON ’∞’°’Ω÷Å’•",
    limit_reached:"‘Ω’°’≤’•÷Ä’´ ’Ω’°’∞’¥’°’∂’® ’∞’°’Ω’°’Æ ’ß÷â ’é’•÷Ä’°’§’°÷Ä’±’´÷Ä ’∏÷Ç’∑÷â ‚è≥",
    win:"üéâ ‘¥’∏÷Ç÷Ñ ’∑’°’∞’•÷Å’´÷Ñ", lose_prefix:"üò¢ ‘¥’∏÷Ç÷Ñ ’®’∂’ø÷Ä’•÷Å’´÷Ñ", lose_mid:"’´’Ω’Ø ’§’∏÷Ç÷Ä’Ω ’•’Ø’°’æ",
    lose_tail:"‚Ä¶ ’ì’∏÷Ä’±’´÷Ä ’Ø÷Ä’Ø’´’∂!"
  }
};
const langs = ["en","ru","zh","hi","hy"];
let lang = localStorage.getItem("t21_lang") || "en";
if(!I18N[lang]) lang = "en";

/* ===================== Helpers ===================== */
const $ = id => document.getElementById(id);
const isTon = s => /^[EU]Q[A-Za-z0-9_-]{46,53}$/.test(String(s||"").trim());

function tkey(k){ return I18N[lang][k]; }
function applyLang(){
  $("titleTxt").textContent = tkey("balance");
  $("playsTxt").textContent = tkey("plays");
  $("limitTxt").textContent = tkey("limit");
  $("btnAd100").textContent = tkey("ad100");
  $("btnAd10").textContent  = tkey("ad10");
  $("adNote").textContent   = tkey("adNote");
  $("guessTxt").textContent = tkey("guess");
  $("addr").placeholder     = tkey("addrPh");
  $("addrHint").textContent = tkey("addrHint");
  $("btnPayout").textContent= tkey("payout");
  $("btnShare").textContent = "üîó " + tkey("share");
  $("langBtn").textContent  = "üåê " + lang.toUpperCase();
}

/* ===================== State Load/Save ===================== */
async function loadState(){
  try{
    const r = await fetch(`${API}/state`);
    const s = await r.json();
    $("balance").textContent = s.balance ?? 0;
    $("plays").textContent   = s.plays   ?? 0;
    $("limit").textContent   = s.limit   ?? 0;
  }catch(e){ console.log("STATE ERR:", e); }
}

async function saveAddr(){
  const a = $("addr").value.trim();
  if(!isTon(a)) { alert(tkey("invalid_addr")); return; }
  try{
    await fetch(`${API}/save_address`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ address:a })
    });
  }catch(e){ console.log("SAVE ADDR ERR:", e); }
}

/* ===================== Ad Modal (30s, skip after 5s) ===================== */
let adTimer = null, adLeft = 30, adDur = 30, adAmount = 0;
function openAd(amount){
  adAmount = amount;
  adLeft = adDur; updateAdUI();
  $("adBack").style.display = "flex";
  $("btnSkip").disabled = true;
  $("btnClose").style.display = "none";
  setTimeout(()=>{ $("btnSkip").disabled = false; }, 5000);

  clearInterval(adTimer);
  adTimer = setInterval(()=>{
    adLeft -= 1;
    updateAdUI();
    if(adLeft <= 0){
      clearInterval(adTimer);
      $("btnClose").style.display = "";
    }
  }, 1000);
}
function updateAdUI(){
  $("adTimer").textContent = `${adLeft}s`;
  const p = Math.max(0, Math.min(100, Math.round(100*(adDur-adLeft)/adDur)));
  $("adFill").style.width = p + "%";
}
function skipAd(){
  clearInterval(adTimer);
  $("btnClose").style.display = "";
}
async function closeAdAndClaim(){
  $("adBack").style.display = "none";
  await watchAd(adAmount);
}

/* ===================== API ops ===================== */
async function watchAd(amount){
  try{
    const r = await fetch(`${API}/ad/amount-${amount}`);
    const s = await r.json();
    $("balance").textContent = s.balance ?? 0;
    $("plays").textContent   = s.plays   ?? 0;
    $("limit").textContent   = s.limit   ?? 0;
  }catch(e){ console.log("AD ERR:", e); }
}

async function play(n){
  const a = $("addr").value.trim();
  if(!isTon(a)){ alert(tkey("invalid_addr")); return; }
  await saveAddr();

  try{
    const r = await fetch(`${API}/play/number-${n}`);
    const d = await r.json();

    if(d.error === "LIMIT_REACHED"){
      alert(tkey("limit_reached"));
      return;
    }

    if(d.win){
      // –±—ç–∫ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ 50; –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º min(d.reward,50)
      alert(`${tkey("win")} ${Math.min(d.reward||0, 50)} T21`);
    }else{
      alert(`${tkey("lose_prefix")} ${d.guess} ‚Äî ${tkey("lose_mid")} ${d.winning} ${tkey("lose_tail")}`);
    }

    $("balance").textContent = d.balance ?? 0;
    $("plays").textContent   = d.plays   ?? 0;
    $("limit").textContent   = d.limit   ?? 0;
  }catch(e){ console.log("PLAY ERR:", e); }
}

async function payout(){
  const a = $("addr").value.trim();
  if(!isTon(a)){ alert(tkey("invalid_addr")); return; }
  await saveAddr();

  try{
    const r = await fetch(`${API}/payout`, { method:"POST" });
    const j = await r.json();
    if(j.ton_link && Telegram?.WebApp?.openLink){
      Telegram.WebApp.openLink(j.ton_link);
    }
    alert(j.message || "OK");
  }catch(e){ console.log("PAYOUT ERR:", e); }
}

function share(){
  // Telegram Mini App share (–µ—Å–ª–∏ –µ—Å—Ç—å)
  if(Telegram?.WebApp?.initDataUnsafe?.user){
    const text = "Play & win T21 ‚Äî T21 Play Zone";
    const url  = SHARE_URL;
    try{
      Telegram.WebApp.openLink(url);
      return;
    }catch(e){}
  }
  // Fallback Web Share API
  if(navigator.share){
    navigator.share({ title:"T21 Play Zone", text:"Play & win T21!", url:SHARE_URL });
  }else{
    prompt("Copy link:", SHARE_URL);
  }
}

/* ===================== UI build + Events ===================== */
function buildGrid(){
  const g = $("grid"); g.innerHTML = "";
  for(let i=1;i<=9;i++){
    const b = document.createElement("div");
    b.className = "key"; b.textContent = i;
    b.onclick = ()=>play(i);
    g.appendChild(b);
  }
}

$("btnAd100").onclick = ()=>openAd(100);
$("btnAd10").onclick  = ()=>openAd(10);
$("btnSkip").onclick  = skipAd;
$("btnClose").onclick = closeAdAndClaim;
$("btnPayout").onclick= payout;
$("btnShare").onclick = share;

$("langBtn").onclick = ()=>{
  const idx = (langs.indexOf(lang)+1) % langs.length;
  lang = langs[idx];
  localStorage.setItem("t21_lang", lang);
  applyLang();
};

buildGrid();
applyLang();
loadState();
</script>
</body>
</html>
